# KingSoft 部署指南

## 快速部署

### 方式一：Docker Compose 部署 (推荐)

**1. 准备环境变量文件**
```bash
# 创建 .env 文件
cat > .env << EOF
POSTGRES_PASSWORD=your-secure-postgres-password
REDIS_PASSWORD=your-secure-redis-password
INFLUXDB_PASSWORD=your-secure-influxdb-password
JWT_SECRET=your-jwt-secret-key
DOMAIN=kingsoft.yourdomain.com
EOF
```

**2. 启动服务**
```bash
# 克隆项目
git clone https://github.com/your-org/kingsoft-admin.git
cd kingsoft-admin

# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps
```

**3. 访问应用**
- 前端界面: http://localhost:3000
- API文档: http://localhost:8080/api/docs

### 方式二：Kubernetes 部署

**1. 创建命名空间和配置**
```bash
# 应用Kubernetes配置
kubectl apply -f k8s/

# 查看部署状态
kubectl get pods -n kingsoft
```

**2. 配置域名**
```bash
# 更新Ingress配置中的域名
kubectl patch ingress kingsoft-ingress -n kingsoft -p '{"spec":{"rules":[{"host":"your-domain.com"}]}}'
```

### 方式三：传统部署

**前端部署:**
```bash
# 构建前端
npm ci
npm run build

# 配置Nginx
sudo cp nginx.conf /etc/nginx/sites-available/kingsoft
sudo ln -s /etc/nginx/sites-available/kingsoft /etc/nginx/sites-enabled/
sudo systemctl reload nginx
```

**后端部署:**
```bash
# 安装后端依赖
cd api && npm ci

# 启动后端服务
npm run start:prod
```

## 环境要求

| 组件 | 最低要求 | 推荐配置 |
|-----|---------|---------|
| **CPU** | 2核 | 4核+ |
| **内存** | 4GB | 8GB+ |
| **磁盘** | 50GB | 100GB SSD |
| **操作系统** | Ubuntu 18.04+ | Ubuntu 20.04+ |
| **Node.js** | 18.x | 18.x LTS |
| **Docker** | 20.10+ | 最新版本 |

## 配置文件说明

### Docker Compose 配置

主要服务配置在 `docker-compose.yml` 中：

```yaml
services:
  frontend:    # React 前端应用
  backend:     # Node.js 后端 API
  postgres:    # 主数据库
  influxdb:    # 时序数据库
  redis:       # 缓存数据库
```

### 环境变量

| 变量名 | 说明 | 示例值 |
|-------|------|-------|
| `POSTGRES_PASSWORD` | PostgreSQL 数据库密码 | `secure-password-123` |
| `REDIS_PASSWORD` | Redis 密码 | `redis-password-456` |
| `JWT_SECRET` | JWT 签名密钥 | `your-jwt-secret` |
| `DOMAIN` | 应用域名 | `kingsoft.example.com` |

## 数据初始化

### 数据库初始化

**PostgreSQL:**
```bash
# 进入数据库容器
docker-compose exec postgres psql -U kingsoft_user -d kingsoft

# 执行初始化SQL
\i /docker-entrypoint-initdb.d/init.sql
```

**InfluxDB:**
```bash
# 创建初始bucket和用户
docker-compose exec influxdb influx setup \
  --username admin \
  --password your-password \
  --org kingsoft \
  --bucket metrics
```

### 初始数据导入

**导入演示数据:**
```bash
# 导入会话数据
curl -X POST http://localhost:8080/api/admin/import-demo-data \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## 健康检查

### 服务状态检查

```bash
# 检查所有服务
docker-compose ps

# 检查前端
curl -I http://localhost:3000

# 检查后端API
curl -I http://localhost:8080/health

# 检查数据库连接
curl -I http://localhost:8080/api/health/db
```

### 日志查看

```bash
# 查看所有服务日志
docker-compose logs

# 查看特定服务日志
docker-compose logs -f backend
docker-compose logs -f postgres
```

## SSL/TLS 配置

### 使用 Let's Encrypt

```bash
# 安装 Certbot
sudo apt install certbot python3-certbot-nginx

# 获取SSL证书
sudo certbot --nginx -d your-domain.com

# 自动续期
echo "0 12 * * * /usr/bin/certbot renew --quiet" | sudo crontab -
```

### 使用自签名证书

```bash
# 生成自签名证书
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout ./ssl/private.key \
  -out ./ssl/certificate.crt
```

## 监控配置

### Prometheus + Grafana

```bash
# 启动监控服务
docker-compose -f docker-compose.monitoring.yml up -d

# 访问Grafana
open http://localhost:3001
# 默认用户名/密码: admin/admin
```

### 基础监控指标

- **应用健康状态**: HTTP健康检查
- **响应时间**: API响应时间监控
- **错误率**: 4xx/5xx错误统计
- **资源使用**: CPU、内存、磁盘使用率

## 备份恢复

### 数据备份

```bash
# PostgreSQL 备份
docker-compose exec postgres pg_dump -U kingsoft_user kingsoft > backup.sql

# InfluxDB 备份
docker-compose exec influxdb influx backup /tmp/backup
docker cp kingsoft-influxdb:/tmp/backup ./influxdb-backup
```

### 数据恢复

```bash
# PostgreSQL 恢复
docker-compose exec -T postgres psql -U kingsoft_user kingsoft < backup.sql

# InfluxDB 恢复
docker cp ./influxdb-backup kingsoft-influxdb:/tmp/backup
docker-compose exec influxdb influx restore /tmp/backup
```

## 常见问题

### 端口冲突

如果端口被占用，可以修改 `docker-compose.yml` 中的端口映射：

```yaml
services:
  frontend:
    ports:
      - "8001:80"  # 改为其他端口
  backend:
    ports:
      - "8081:8080"  # 改为其他端口
```

### 内存不足

对于低内存环境，可以调整服务配置：

```yaml
services:
  backend:
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
```

### 数据库连接问题

检查数据库服务是否正常启动：

```bash
# 检查PostgreSQL
docker-compose exec postgres pg_isready

# 检查连接
docker-compose exec backend npm run db:test
```

## 性能优化

### 生产环境优化

**1. 启用缓存**
```bash
# Redis 缓存配置
export REDIS_CACHE_TTL=3600
export ENABLE_QUERY_CACHE=true
```

**2. 数据库优化**
```sql
-- PostgreSQL 配置优化
ALTER SYSTEM SET shared_buffers = '256MB';
ALTER SYSTEM SET effective_cache_size = '1GB';
```

**3. 前端优化**
```bash
# 启用Gzip压缩
nginx_conf="gzip on; gzip_types text/plain text/css application/json;"
```

### 扩容指南

**水平扩容后端:**
```yaml
services:
  backend:
    deploy:
      replicas: 3  # 增加副本数
```

**数据库读写分离:**
```yaml
services:
  postgres-master:
    # 主数据库配置
  postgres-slave:
    # 从数据库配置
```

## 安全配置

### 网络安全

```bash
# 防火墙配置
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable
```

### 应用安全

```yaml
# Docker Compose 安全配置
services:
  backend:
    security_opt:
      - no-new-privileges:true
    read_only: true
    user: "1001:1001"
```

## 故障排查

### 常见错误及解决方案

**1. 应用无法启动**
```bash
# 检查日志
docker-compose logs backend
# 检查配置
docker-compose config
```

**2. 数据库连接失败**
```bash
# 检查数据库状态
docker-compose exec postgres pg_isready
# 检查网络连接
docker-compose exec backend ping postgres
```

**3. 前端页面空白**
```bash
# 检查构建产物
docker-compose exec frontend ls -la /usr/share/nginx/html
# 检查Nginx配置
docker-compose exec frontend nginx -t
```

## 升级指南

### 应用升级

```bash
# 1. 备份数据
./scripts/backup.sh

# 2. 拉取最新代码
git pull origin main

# 3. 重新构建镜像
docker-compose build

# 4. 滚动更新
docker-compose up -d --force-recreate
```

### 数据库迁移

```bash
# 执行数据库迁移
docker-compose exec backend npm run migrate:latest

# 验证迁移结果
docker-compose exec backend npm run migrate:status
```

---

## 获取支持

- 📚 **完整文档**: [部署运维指南](./部署运维指南.md)
- 🐛 **问题反馈**: [GitHub Issues](https://github.com/your-org/kingsoft-admin/issues)
- 💬 **技术支持**: support@kingsoft.com
- 📞 **紧急联系**: +86-400-XXX-XXXX

---

**最后更新**: 2024-08-21  
**适用版本**: KingSoft v1.0+