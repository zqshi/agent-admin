# CogVision 数据字典
## Data Dictionary

**文档版本**: V1.0  
**创建日期**: 2024-08-21  
**最后更新**: 2024-08-21  
**维护团队**: 数据架构组  

---

## 1. 概述

本数据字典详细定义了CogVision数字员工智能管理平台中所有的数据实体、字段定义、数据类型、约束条件和业务规则。

## 2. 数据库架构

### 2.1 主数据库 (PostgreSQL)

用于存储结构化的核心业务数据，包括用户信息、会话记录、A/B测试数据等。

### 2.2 时序数据库 (InfluxDB)

用于存储时间序列数据，包括性能指标、监控数据、实时状态等。

### 2.3 缓存数据库 (Redis)

用于缓存热点数据、会话状态、实时计算结果等。

## 3. 核心数据实体

### 3.1 会话相关表 (Session Tables)

#### sessions - 会话主表

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
|--------|----------|------|----------|--------|------|
| id | VARCHAR | 64 | NOT NULL | UUID | 会话唯一标识符 |
| user_id | VARCHAR | 64 | NOT NULL | - | 用户标识符 |
| digital_employee_id | VARCHAR | 64 | NULL | - | 服务的数字员工ID |
| start_time | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 会话开始时间 |
| end_time | TIMESTAMP | - | NULL | - | 会话结束时间 |
| status | VARCHAR | 20 | NOT NULL | 'running' | 会话状态: running/success/failed |
| total_messages | INTEGER | - | NOT NULL | 0 | 总消息数量 |
| llm_calls | INTEGER | - | NOT NULL | 0 | LLM调用次数 |
| tool_calls | INTEGER | - | NOT NULL | 0 | 工具调用次数 |
| tokens_used | INTEGER | - | NOT NULL | 0 | Token消耗总量 |
| response_time | DECIMAL | 10,3 | NULL | - | 平均响应时间(秒) |
| success_rate | DECIMAL | 5,2 | NULL | - | 会话成功率(%) |
| satisfaction_score | DECIMAL | 3,2 | NULL | - | 用户满意度评分(1-5) |
| error_count | INTEGER | - | NOT NULL | 0 | 错误次数 |
| ab_test_id | VARCHAR | 64 | NULL | - | 关联的A/B测试ID |
| ab_test_group | VARCHAR | 32 | NULL | - | A/B测试分组 |
| metadata | JSONB | - | NULL | - | 扩展元数据 |
| created_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 记录创建时间 |
| updated_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 记录更新时间 |

**主键**: id  
**索引**: user_id, start_time, status, ab_test_id  
**外键**: digital_employee_id → digital_employees(id), ab_test_id → ab_tests(id)  

#### chat_messages - 对话消息表

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
|--------|----------|------|----------|--------|------|
| id | VARCHAR | 64 | NOT NULL | UUID | 消息唯一标识符 |
| session_id | VARCHAR | 64 | NOT NULL | - | 所属会话ID |
| role | VARCHAR | 20 | NOT NULL | - | 消息角色: user/assistant/system |
| content | TEXT | - | NOT NULL | - | 消息内容 |
| content_type | VARCHAR | 20 | NOT NULL | 'text' | 内容类型: text/image/file |
| timestamp | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 消息时间戳 |
| token_count | INTEGER | - | NOT NULL | 0 | 该消息的Token数量 |
| processing_time | DECIMAL | 10,3 | NULL | - | 处理耗时(秒) |
| metadata | JSONB | - | NULL | - | 消息元数据 |

**主键**: id  
**索引**: session_id, timestamp, role  
**外键**: session_id → sessions(id)  

#### llm_traces - LLM调用追踪表

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
|--------|----------|------|----------|--------|------|
| id | VARCHAR | 64 | NOT NULL | UUID | 追踪记录唯一标识符 |
| session_id | VARCHAR | 64 | NOT NULL | - | 所属会话ID |
| message_id | VARCHAR | 64 | NULL | - | 关联的消息ID |
| model_name | VARCHAR | 64 | NOT NULL | - | 使用的模型名称 |
| model_version | VARCHAR | 32 | NULL | - | 模型版本 |
| prompt | TEXT | - | NOT NULL | - | 完整提示词 |
| response | TEXT | - | NULL | - | 模型回复内容 |
| tokens_input | INTEGER | - | NOT NULL | 0 | 输入Token数量 |
| tokens_output | INTEGER | - | NOT NULL | 0 | 输出Token数量 |
| tokens_total | INTEGER | - | NOT NULL | 0 | Token总量 |
| response_time | DECIMAL | 10,3 | NOT NULL | - | 响应时间(秒) |
| temperature | DECIMAL | 3,2 | NULL | - | 温度参数 |
| max_tokens | INTEGER | - | NULL | - | 最大Token限制 |
| top_p | DECIMAL | 3,2 | NULL | - | top_p参数 |
| status | VARCHAR | 20 | NOT NULL | - | 调用状态: success/failed/timeout |
| error_message | TEXT | - | NULL | - | 错误信息 |
| cost | DECIMAL | 10,6 | NULL | - | 调用成本(USD) |
| timestamp | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 调用时间戳 |

**主键**: id  
**索引**: session_id, model_name, timestamp, status  
**外键**: session_id → sessions(id), message_id → chat_messages(id)  

#### tool_traces - 工具调用追踪表

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
|--------|----------|------|----------|--------|------|
| id | VARCHAR | 64 | NOT NULL | UUID | 追踪记录唯一标识符 |
| session_id | VARCHAR | 64 | NOT NULL | - | 所属会话ID |
| tool_name | VARCHAR | 128 | NOT NULL | - | 工具名称 |
| tool_version | VARCHAR | 32 | NULL | - | 工具版本 |
| parameters | JSONB | - | NULL | - | 调用参数 |
| result | JSONB | - | NULL | - | 返回结果 |
| status | VARCHAR | 20 | NOT NULL | - | 调用状态: success/failed/timeout |
| response_time | DECIMAL | 10,3 | NOT NULL | - | 响应时间(秒) |
| error_message | TEXT | - | NULL | - | 错误信息 |
| retry_count | INTEGER | - | NOT NULL | 0 | 重试次数 |
| timestamp | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 调用时间戳 |

**主键**: id  
**索引**: session_id, tool_name, timestamp, status  
**外键**: session_id → sessions(id)  

#### reasoning_steps - 推理步骤表

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
|--------|----------|------|----------|--------|------|
| id | VARCHAR | 64 | NOT NULL | UUID | 推理步骤唯一标识符 |
| session_id | VARCHAR | 64 | NOT NULL | - | 所属会话ID |
| step_number | INTEGER | - | NOT NULL | - | 步骤序号 |
| step_type | VARCHAR | 32 | NOT NULL | - | 步骤类型: thinking/tool_decision/tool_execution/response_generation |
| title | VARCHAR | 255 | NOT NULL | - | 步骤标题 |
| content | TEXT | - | NOT NULL | - | 步骤内容 |
| status | VARCHAR | 20 | NOT NULL | - | 步骤状态: completed/processing/pending/error |
| start_time | TIMESTAMP | - | NOT NULL | - | 开始时间 |
| end_time | TIMESTAMP | - | NULL | - | 结束时间 |
| duration | DECIMAL | 10,3 | NULL | - | 执行时长(秒) |
| metadata | JSONB | - | NULL | - | 步骤元数据 |

**主键**: id  
**索引**: session_id, step_number, step_type  
**外键**: session_id → sessions(id)  

### 3.2 用户管理表 (User Management Tables)

#### users - 用户表

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
|--------|----------|------|----------|--------|------|
| id | VARCHAR | 64 | NOT NULL | UUID | 用户唯一标识符 |
| username | VARCHAR | 64 | NOT NULL | - | 用户名 |
| email | VARCHAR | 255 | NOT NULL | - | 邮箱地址 |
| password_hash | VARCHAR | 255 | NULL | - | 密码哈希 |
| full_name | VARCHAR | 128 | NULL | - | 全名 |
| role | VARCHAR | 32 | NOT NULL | 'user' | 用户角色: admin/manager/analyst/user |
| department | VARCHAR | 64 | NULL | - | 部门 |
| is_active | BOOLEAN | - | NOT NULL | TRUE | 是否激活 |
| last_login | TIMESTAMP | - | NULL | - | 最后登录时间 |
| preferences | JSONB | - | NULL | - | 用户偏好设置 |
| created_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 更新时间 |

**主键**: id  
**唯一索引**: username, email  
**索引**: role, department, is_active  

#### digital_employees - 数字员工表

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
|--------|----------|------|----------|--------|------|
| id | VARCHAR | 64 | NOT NULL | UUID | 数字员工唯一标识符 |
| name | VARCHAR | 128 | NOT NULL | - | 数字员工名称 |
| display_name | VARCHAR | 128 | NULL | - | 显示名称 |
| description | TEXT | - | NULL | - | 描述信息 |
| role | VARCHAR | 64 | NOT NULL | - | 职责角色 |
| status | VARCHAR | 20 | NOT NULL | 'active' | 状态: active/inactive/maintenance |
| default_model | VARCHAR | 64 | NOT NULL | - | 默认使用的模型 |
| system_prompt | TEXT | - | NULL | - | 系统提示词 |
| available_tools | JSONB | - | NULL | - | 可用工具列表 |
| config | JSONB | - | NULL | - | 配置参数 |
| created_by | VARCHAR | 64 | NOT NULL | - | 创建者用户ID |
| created_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 更新时间 |

**主键**: id  
**唯一索引**: name  
**索引**: status, role, created_by  
**外键**: created_by → users(id)  

### 3.3 A/B测试相关表 (AB Testing Tables)

#### ab_tests - A/B测试表

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
|--------|----------|------|----------|--------|------|
| id | VARCHAR | 64 | NOT NULL | UUID | 实验唯一标识符 |
| name | VARCHAR | 255 | NOT NULL | - | 实验名称 |
| description | TEXT | - | NULL | - | 实验描述 |
| hypothesis | TEXT | - | NULL | - | 实验假设 |
| status | VARCHAR | 20 | NOT NULL | 'draft' | 实验状态: draft/running/paused/completed/archived |
| start_date | TIMESTAMP | - | NULL | - | 开始时间 |
| end_date | TIMESTAMP | - | NULL | - | 结束时间 |
| planned_duration_days | INTEGER | - | NULL | - | 计划持续天数 |
| min_sample_size | INTEGER | - | NOT NULL | 1000 | 最小样本量 |
| significance_level | DECIMAL | 3,2 | NOT NULL | 0.05 | 显著性水平 |
| power | DECIMAL | 3,2 | NOT NULL | 0.8 | 统计功效 |
| primary_metric | VARCHAR | 64 | NOT NULL | - | 主要指标 |
| secondary_metrics | JSONB | - | NULL | - | 次要指标列表 |
| target_audience | JSONB | - | NULL | - | 目标受众配置 |
| created_by | VARCHAR | 64 | NOT NULL | - | 创建者用户ID |
| winner_group_id | VARCHAR | 64 | NULL | - | 获胜组ID |
| confidence_level | DECIMAL | 5,2 | NULL | - | 置信度 |
| effect_size | DECIMAL | 10,6 | NULL | - | 效应大小 |
| notes | TEXT | - | NULL | - | 备注 |
| created_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 更新时间 |

**主键**: id  
**索引**: status, start_date, created_by, primary_metric  
**外键**: created_by → users(id), winner_group_id → ab_test_groups(id)  

#### ab_test_groups - A/B测试分组表

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
|--------|----------|------|----------|--------|------|
| id | VARCHAR | 64 | NOT NULL | UUID | 分组唯一标识符 |
| test_id | VARCHAR | 64 | NOT NULL | - | 所属实验ID |
| name | VARCHAR | 128 | NOT NULL | - | 分组名称 |
| description | TEXT | - | NULL | - | 分组描述 |
| is_control | BOOLEAN | - | NOT NULL | FALSE | 是否为对照组 |
| traffic_percentage | DECIMAL | 5,2 | NOT NULL | - | 流量分配百分比 |
| configuration | JSONB | - | NOT NULL | - | 分组配置参数 |
| model_config | JSONB | - | NULL | - | 模型配置 |
| prompt_template | TEXT | - | NULL | - | 提示词模板 |
| tools_config | JSONB | - | NULL | - | 工具配置 |
| custom_parameters | JSONB | - | NULL | - | 自定义参数 |

**主键**: id  
**索引**: test_id, name  
**外键**: test_id → ab_tests(id)  

#### ab_test_metrics - A/B测试指标表

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
|--------|----------|------|----------|--------|------|
| id | VARCHAR | 64 | NOT NULL | UUID | 指标记录唯一标识符 |
| test_id | VARCHAR | 64 | NOT NULL | - | 所属实验ID |
| group_id | VARCHAR | 64 | NOT NULL | - | 所属分组ID |
| metric_name | VARCHAR | 64 | NOT NULL | - | 指标名称 |
| metric_value | DECIMAL | 15,6 | NOT NULL | - | 指标值 |
| sample_size | INTEGER | - | NOT NULL | 0 | 样本数量 |
| confidence_interval_lower | DECIMAL | 15,6 | NULL | - | 置信区间下限 |
| confidence_interval_upper | DECIMAL | 15,6 | NULL | - | 置信区间上限 |
| standard_error | DECIMAL | 15,6 | NULL | - | 标准误差 |
| p_value | DECIMAL | 15,10 | NULL | - | P值 |
| calculated_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 计算时间 |

**主键**: id  
**索引**: test_id, group_id, metric_name, calculated_at  
**外键**: test_id → ab_tests(id), group_id → ab_test_groups(id)  

### 3.4 系统配置表 (System Configuration Tables)

#### system_configs - 系统配置表

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
|--------|----------|------|----------|--------|------|
| id | SERIAL | - | NOT NULL | AUTO | 配置ID |
| config_key | VARCHAR | 128 | NOT NULL | - | 配置键 |
| config_value | TEXT | - | NULL | - | 配置值 |
| config_type | VARCHAR | 32 | NOT NULL | 'string' | 配置类型: string/number/boolean/json |
| category | VARCHAR | 64 | NOT NULL | - | 配置分类 |
| description | TEXT | - | NULL | - | 配置描述 |
| is_encrypted | BOOLEAN | - | NOT NULL | FALSE | 是否加密存储 |
| updated_by | VARCHAR | 64 | NULL | - | 更新者用户ID |
| updated_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 更新时间 |

**主键**: id  
**唯一索引**: config_key  
**索引**: category  

#### audit_logs - 审计日志表

| 字段名 | 数据类型 | 长度 | 是否为空 | 默认值 | 说明 |
|--------|----------|------|----------|--------|------|
| id | BIGSERIAL | - | NOT NULL | AUTO | 日志ID |
| user_id | VARCHAR | 64 | NULL | - | 操作用户ID |
| action | VARCHAR | 64 | NOT NULL | - | 操作类型 |
| resource_type | VARCHAR | 64 | NOT NULL | - | 资源类型 |
| resource_id | VARCHAR | 64 | NULL | - | 资源ID |
| details | JSONB | - | NULL | - | 操作详情 |
| ip_address | INET | - | NULL | - | IP地址 |
| user_agent | TEXT | - | NULL | - | 用户代理 |
| timestamp | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 操作时间 |

**主键**: id  
**索引**: user_id, action, resource_type, timestamp  

## 4. 时序数据结构 (InfluxDB)

### 4.1 系统性能指标

**Measurement**: `system_metrics`

| Field | Type | Description |
|-------|------|-------------|
| cpu_usage | float | CPU使用率(%) |
| memory_usage | float | 内存使用率(%) |
| disk_usage | float | 磁盘使用率(%) |
| network_in | integer | 网络入流量(bytes) |
| network_out | integer | 网络出流量(bytes) |

**Tags**: host, environment, service_name

### 4.2 业务性能指标

**Measurement**: `business_metrics`

| Field | Type | Description |
|-------|------|-------------|
| active_sessions | integer | 活跃会话数 |
| requests_per_minute | integer | 每分钟请求数 |
| avg_response_time | float | 平均响应时间(ms) |
| success_rate | float | 成功率(%) |
| error_rate | float | 错误率(%) |
| token_usage | integer | Token使用量 |

**Tags**: digital_employee_id, model_name, environment

### 4.3 用户行为指标

**Measurement**: `user_behavior`

| Field | Type | Description |
|-------|------|-------------|
| session_duration | float | 会话持续时间(秒) |
| message_count | integer | 消息数量 |
| tool_calls | integer | 工具调用次数 |
| satisfaction_score | float | 满意度评分 |

**Tags**: user_id, digital_employee_id, session_type

## 5. 缓存数据结构 (Redis)

### 5.1 会话状态缓存

**Key Pattern**: `session:{session_id}`  
**TTL**: 3600 seconds  
**Type**: Hash  

```json
{
  "status": "active",
  "user_id": "user_123",
  "digital_employee_id": "de_001",
  "start_time": "2024-08-21T10:00:00Z",
  "message_count": 5,
  "last_activity": "2024-08-21T10:05:30Z"
}
```

### 5.2 实时统计缓存

**Key Pattern**: `stats:{type}:{period}`  
**TTL**: 300 seconds  
**Type**: Hash  

```json
{
  "active_users": 1234,
  "total_sessions": 5678,
  "avg_response_time": 2.34,
  "success_rate": 94.5
}
```

### 5.3 用户会话缓存

**Key Pattern**: `user_session:{user_id}`  
**TTL**: 86400 seconds  
**Type**: String  

```json
{
  "session_id": "sess_123",
  "user_id": "user_456",
  "permissions": ["read", "write"],
  "last_access": "2024-08-21T10:30:00Z"
}
```

## 6. 数据约束和业务规则

### 6.1 数据完整性约束

1. **会话数据完整性**
   - 每个会话必须有开始时间
   - 已结束的会话必须有结束时间
   - 会话的总消息数必须等于实际消息条数

2. **A/B测试完整性**
   - 所有分组的流量分配总和必须等于100%
   - 实验结束时间必须晚于开始时间
   - 至少需要2个分组才能创建实验

3. **用户权限完整性**
   - 删除用户前必须先处理其创建的资源
   - 管理员不能删除自己的账户
   - 角色变更需要权限验证

### 6.2 业务规则

1. **会话生命周期**
   - 会话超时时间: 30分钟
   - 最大会话时长: 24小时
   - 最大消息数量: 1000条

2. **A/B测试规则**
   - 最小运行时间: 24小时
   - 最小样本量: 每组100个会话
   - 置信度阈值: 95%

3. **数据保留策略**
   - 会话数据保留: 2年
   - 审计日志保留: 5年
   - 时序数据保留: 1年
   - 缓存数据TTL: 1小时-1天

### 6.3 数据质量检查

1. **数据一致性检查**
   ```sql
   -- 检查会话消息数一致性
   SELECT s.id, s.total_messages, COUNT(m.id) as actual_messages
   FROM sessions s
   LEFT JOIN chat_messages m ON s.id = m.session_id
   GROUP BY s.id, s.total_messages
   HAVING s.total_messages != COUNT(m.id);
   ```

2. **数据完整性检查**
   ```sql
   -- 检查孤立的消息记录
   SELECT m.id
   FROM chat_messages m
   LEFT JOIN sessions s ON m.session_id = s.id
   WHERE s.id IS NULL;
   ```

## 7. 索引策略

### 7.1 查询优化索引

```sql
-- 会话查询优化
CREATE INDEX CONCURRENTLY idx_sessions_user_time 
ON sessions(user_id, start_time DESC);

CREATE INDEX CONCURRENTLY idx_sessions_status_time 
ON sessions(status, start_time DESC) 
WHERE status IN ('running', 'failed');

-- 消息搜索优化
CREATE INDEX CONCURRENTLY idx_messages_content_search 
ON chat_messages USING gin(to_tsvector('english', content));

-- 工具调用分析优化
CREATE INDEX CONCURRENTLY idx_tool_traces_tool_time 
ON tool_traces(tool_name, timestamp DESC);
```

### 7.2 分区策略

```sql
-- 会话表按时间分区
CREATE TABLE sessions_y2024m08 PARTITION OF sessions
FOR VALUES FROM ('2024-08-01') TO ('2024-09-01');

-- 审计日志按月分区
CREATE TABLE audit_logs_y2024m08 PARTITION OF audit_logs
FOR VALUES FROM ('2024-08-01') TO ('2024-09-01');
```

## 8. 数据迁移脚本

### 8.1 初始化脚本

```sql
-- 创建扩展
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pg_trgm";

-- 创建枚举类型
CREATE TYPE session_status AS ENUM ('running', 'success', 'failed');
CREATE TYPE user_role AS ENUM ('admin', 'manager', 'analyst', 'user');
CREATE TYPE ab_test_status AS ENUM ('draft', 'running', 'paused', 'completed', 'archived');
```

### 8.2 数据清理脚本

```sql
-- 清理过期会话数据
DELETE FROM sessions 
WHERE end_time < NOW() - INTERVAL '2 years';

-- 清理过期缓存数据
DELETE FROM system_configs 
WHERE config_key LIKE 'cache_%' 
AND updated_at < NOW() - INTERVAL '1 day';
```

---

**维护说明**: 本数据字典需要随着系统功能更新而同步维护，确保数据结构定义的准确性和完整性。

**版本控制**: 所有数据库变更都必须通过migration脚本进行，确保数据结构变更的可追溯性。