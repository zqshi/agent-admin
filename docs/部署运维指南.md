# CogVision éƒ¨ç½²è¿ç»´æŒ‡å—

## ç›®å½•
1. [ç¯å¢ƒå‡†å¤‡](#1-ç¯å¢ƒå‡†å¤‡)
2. [å‰ç«¯éƒ¨ç½²](#2-å‰ç«¯éƒ¨ç½²)
3. [åç«¯éƒ¨ç½²](#3-åç«¯éƒ¨ç½²)
4. [æ•°æ®åº“é…ç½®](#4-æ•°æ®åº“é…ç½®)
5. [å®¹å™¨åŒ–éƒ¨ç½²](#5-å®¹å™¨åŒ–éƒ¨ç½²)
6. [Kuberneteséƒ¨ç½²](#6-kuberneteséƒ¨ç½²)
7. [CI/CDæµæ°´çº¿](#7-cicdæµæ°´çº¿)
8. [ç›‘æ§å‘Šè­¦](#8-ç›‘æ§å‘Šè­¦)
9. [æ—¥å¸¸è¿ç»´](#9-æ—¥å¸¸è¿ç»´)
10. [æ•…éšœæ’æŸ¥](#10-æ•…éšœæ’æŸ¥)

---

## 1. ç¯å¢ƒå‡†å¤‡

### 1.1 ç³»ç»Ÿè¦æ±‚

**å‰ç«¯ç¯å¢ƒ:**
- Node.js 18.x+ 
- npm 8.x+ æˆ– yarn 1.22+
- å†…å­˜: æœ€å°‘2GBï¼Œæ¨è4GB+
- ç£ç›˜: æœ€å°‘10GBå¯ç”¨ç©ºé—´

**åç«¯ç¯å¢ƒ:**
- CPU: æœ€å°‘2æ ¸ï¼Œæ¨è4æ ¸+
- å†…å­˜: æœ€å°‘4GBï¼Œæ¨è8GB+
- ç£ç›˜: æœ€å°‘50GB SSD
- ç½‘ç»œ: 1Gbpså¸¦å®½

**æ•°æ®åº“ç¯å¢ƒ:**
- PostgreSQL 14+
- InfluxDB 2.x
- Redis 6.x+

### 1.2 ç½‘ç»œé…ç½®

**ç«¯å£é…ç½®:**
```bash
# å‰ç«¯åº”ç”¨
3000/tcp    # å¼€å‘æœåŠ¡å™¨
80/tcp      # HTTP (ç”Ÿäº§ç¯å¢ƒ)
443/tcp     # HTTPS (ç”Ÿäº§ç¯å¢ƒ)

# åç«¯æœåŠ¡
8080/tcp    # APIæœåŠ¡
8081/tcp    # ç®¡ç†æ¥å£

# æ•°æ®åº“
5432/tcp    # PostgreSQL
8086/tcp    # InfluxDB
6379/tcp    # Redis
```

**é˜²ç«å¢™é…ç½®:**
```bash
# CentOS/RHEL
firewall-cmd --permanent --add-port=80/tcp
firewall-cmd --permanent --add-port=443/tcp
firewall-cmd --reload

# Ubuntu/Debian
ufw allow 80/tcp
ufw allow 443/tcp
ufw enable
```

### 1.3 ä¾èµ–å®‰è£…

**å®‰è£…Node.js:**
```bash
# ä½¿ç”¨NVMå®‰è£…Node.js
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 18
nvm use 18
nvm alias default 18

# éªŒè¯å®‰è£…
node --version
npm --version
```

**å®‰è£…Docker (å¯é€‰):**
```bash
# Ubuntu/Debian
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER

# CentOS/RHEL
sudo yum install -y yum-utils
sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
sudo yum install -y docker-ce docker-ce-cli containerd.io
sudo systemctl enable docker
sudo systemctl start docker
```

---

## 2. å‰ç«¯éƒ¨ç½²

### 2.1 ç”Ÿäº§æ„å»º

**å…‹éš†ä»£ç :**
```bash
git clone https://github.com/your-org/cogvision-admin.git
cd cogvision-admin
```

**å®‰è£…ä¾èµ–å¹¶æ„å»º:**
```bash
# å®‰è£…ä¾èµ–
npm ci --only=production

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
npm run build

# éªŒè¯æ„å»ºäº§ç‰©
ls -la dist/
```

### 2.2 Nginxé…ç½®

**å®‰è£…Nginx:**
```bash
# Ubuntu/Debian
sudo apt update && sudo apt install -y nginx

# CentOS/RHEL
sudo yum install -y nginx
```

**é…ç½®æ–‡ä»¶ (`/etc/nginx/sites-available/cogvision`):**
```nginx
server {
    listen 80;
    server_name cogvision.yourdomain.com;
    root /var/www/cogvision/dist;
    index index.html;

    # å¤„ç†React Router
    location / {
        try_files $uri $uri/ /index.html;
    }

    # APIä»£ç†
    location /api/ {
        proxy_pass http://localhost:8080/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # é™æ€èµ„æºç¼“å­˜
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, no-transform";
    }

    # å‹ç¼©é…ç½®
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;
}
```

**å¯ç”¨é…ç½®:**
```bash
# åˆ›å»ºç¬¦å·é“¾æ¥
sudo ln -s /etc/nginx/sites-available/cogvision /etc/nginx/sites-enabled/

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡å¯Nginx
sudo systemctl restart nginx
sudo systemctl enable nginx
```

### 2.3 HTTPSé…ç½® (ä½¿ç”¨Let's Encrypt)

**å®‰è£…Certbot:**
```bash
# Ubuntu/Debian
sudo apt install -y certbot python3-certbot-nginx

# CentOS/RHEL
sudo yum install -y certbot python3-certbot-nginx
```

**è·å–SSLè¯ä¹¦:**
```bash
sudo certbot --nginx -d cogvision.yourdomain.com
```

**è‡ªåŠ¨ç»­æœŸ:**
```bash
# æ·»åŠ cronä»»åŠ¡
echo "0 12 * * * /usr/bin/certbot renew --quiet" | sudo crontab -
```

### 2.4 éƒ¨ç½²è„šæœ¬

**åˆ›å»ºéƒ¨ç½²è„šæœ¬ (`deploy.sh`):**
```bash
#!/bin/bash
set -e

PROJECT_DIR="/var/www/cogvision"
BACKUP_DIR="/var/backups/cogvision"
NGINX_CONFIG="/etc/nginx/sites-available/cogvision"

echo "ğŸš€ å¼€å§‹éƒ¨ç½² CogVision å‰ç«¯..."

# åˆ›å»ºå¤‡ä»½
echo "ğŸ“¦ åˆ›å»ºå¤‡ä»½..."
sudo mkdir -p $BACKUP_DIR
sudo tar -czf $BACKUP_DIR/cogvision-$(date +%Y%m%d-%H%M%S).tar.gz -C $PROJECT_DIR .

# æ‹‰å–æœ€æ–°ä»£ç 
echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
cd $PROJECT_DIR
git pull origin main

# å®‰è£…ä¾èµ–
echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
npm ci --only=production

# æ„å»ºåº”ç”¨
echo "ğŸ”§ æ„å»ºåº”ç”¨..."
npm run build

# é‡å¯Nginx
echo "ğŸ”„ é‡å¯Nginx..."
sudo nginx -t && sudo systemctl reload nginx

echo "âœ… éƒ¨ç½²å®Œæˆ!"
echo "ğŸŒ è®¿é—®åœ°å€: https://cogvision.yourdomain.com"
```

---

## 3. åç«¯éƒ¨ç½²

### 3.1 Pythonåç«¯ (ç¤ºä¾‹)

**ä¾èµ–å®‰è£…:**
```bash
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3 -m venv venv
source venv/bin/activate

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

**é…ç½®æ–‡ä»¶ (`config/production.py`):**
```python
import os

class Config:
    SECRET_KEY = os.environ.get('SECRET_KEY')
    
    # æ•°æ®åº“é…ç½®
    POSTGRES_URL = os.environ.get('POSTGRES_URL')
    INFLUXDB_URL = os.environ.get('INFLUXDB_URL')
    REDIS_URL = os.environ.get('REDIS_URL')
    
    # JWTé…ç½®
    JWT_SECRET_KEY = os.environ.get('JWT_SECRET_KEY')
    JWT_EXPIRATION_HOURS = 24
    
    # APIé…ç½®
    API_RATE_LIMIT = "1000 per hour"
    CORS_ORIGINS = ["https://cogvision.yourdomain.com"]
    
    # ç›‘æ§é…ç½®
    PROMETHEUS_ENABLED = True
    HEALTH_CHECK_ENABLED = True
```

**SystemdæœåŠ¡é…ç½® (`/etc/systemd/system/cogvision-api.service`):**
```ini
[Unit]
Description=CogVision API Server
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/opt/cogvision-api
Environment=PATH=/opt/cogvision-api/venv/bin
ExecStart=/opt/cogvision-api/venv/bin/python app.py
Restart=always
RestartSec=10

# ç¯å¢ƒå˜é‡
Environment=FLASK_ENV=production
Environment=SECRET_KEY=your-secret-key
Environment=POSTGRES_URL=postgresql://user:pass@localhost:5432/cogvision
Environment=REDIS_URL=redis://localhost:6379/0

[Install]
WantedBy=multi-user.target
```

**å¯åŠ¨æœåŠ¡:**
```bash
sudo systemctl daemon-reload
sudo systemctl enable cogvision-api
sudo systemctl start cogvision-api
sudo systemctl status cogvision-api
```

### 3.2 Node.jsåç«¯ (ç¤ºä¾‹)

**å®‰è£…ä¾èµ–:**
```bash
cd cogvision-api
npm ci --only=production
```

**é…ç½®æ–‡ä»¶ (`config/production.json`):**
```json
{
  "server": {
    "port": 8080,
    "host": "0.0.0.0"
  },
  "database": {
    "postgres": {
      "host": "localhost",
      "port": 5432,
      "database": "cogvision",
      "username": "cogvision_user",
      "password": "${POSTGRES_PASSWORD}"
    },
    "influxdb": {
      "url": "http://localhost:8086",
      "token": "${INFLUXDB_TOKEN}",
      "org": "cogvision",
      "bucket": "metrics"
    },
    "redis": {
      "host": "localhost",
      "port": 6379,
      "password": "${REDIS_PASSWORD}"
    }
  },
  "auth": {
    "jwtSecret": "${JWT_SECRET}",
    "tokenExpiration": "24h"
  },
  "logging": {
    "level": "info",
    "format": "json"
  }
}
```

**PM2é…ç½® (`ecosystem.config.js`):**
```javascript
module.exports = {
  apps: [{
    name: 'cogvision-api',
    script: 'dist/server.js',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 8080
    },
    env_production: {
      NODE_ENV: 'production',
      PORT: 8080,
      POSTGRES_PASSWORD: process.env.POSTGRES_PASSWORD,
      JWT_SECRET: process.env.JWT_SECRET
    },
    log_file: './logs/combined.log',
    out_file: './logs/out.log',
    error_file: './logs/error.log',
    log_date_format: 'YYYY-MM-DD HH:mm Z',
    max_memory_restart: '2G'
  }]
}
```

---

## 4. æ•°æ®åº“é…ç½®

### 4.1 PostgreSQLé…ç½®

**å®‰è£…PostgreSQL:**
```bash
# Ubuntu/Debian
sudo apt install -y postgresql postgresql-contrib

# CentOS/RHEL
sudo yum install -y postgresql-server postgresql-contrib
sudo postgresql-setup initdb
```

**åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·:**
```sql
-- è¿æ¥åˆ°PostgreSQL
sudo -u postgres psql

-- åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·
CREATE DATABASE cogvision;
CREATE USER cogvision_user WITH PASSWORD 'your-secure-password';
GRANT ALL PRIVILEGES ON DATABASE cogvision TO cogvision_user;

-- é€€å‡º
\q
```

**é…ç½®æ–‡ä»¶ä¼˜åŒ– (`/etc/postgresql/14/main/postgresql.conf`):**
```conf
# å†…å­˜é…ç½®
shared_buffers = 256MB
effective_cache_size = 1GB
work_mem = 4MB
maintenance_work_mem = 64MB

# è¿æ¥é…ç½®
max_connections = 200
listen_addresses = '*'

# æ—¥å¿—é…ç½®
log_destination = 'csvlog'
logging_collector = on
log_directory = 'pg_log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_min_duration_statement = 1000

# æ€§èƒ½é…ç½®
checkpoint_completion_target = 0.7
wal_buffers = 16MB
default_statistics_target = 100
```

### 4.2 InfluxDBé…ç½®

**å®‰è£…InfluxDB:**
```bash
# ä¸‹è½½å’Œå®‰è£…
wget -qO- https://repos.influxdata.com/influxdb.key | sudo apt-key add -
echo "deb https://repos.influxdata.com/ubuntu focal stable" | sudo tee /etc/apt/sources.list.d/influxdb.list
sudo apt update && sudo apt install -y influxdb2
```

**åˆå§‹åŒ–é…ç½®:**
```bash
# å¯åŠ¨æœåŠ¡
sudo systemctl enable influxdb
sudo systemctl start influxdb

# åˆå§‹åŒ–è®¾ç½®
influx setup \
  --username admin \
  --password your-secure-password \
  --org cogvision \
  --bucket metrics \
  --force
```

**é…ç½®æ–‡ä»¶ (`/etc/influxdb/config.toml`):**
```toml
[meta]
  dir = "/var/lib/influxdb/meta"

[data]
  dir = "/var/lib/influxdb/data"
  wal-dir = "/var/lib/influxdb/wal"

[http]
  enabled = true
  bind-address = ":8086"
  auth-enabled = true
  log-enabled = true
  write-tracing = false
  pprof-enabled = false

[logging]
  format = "auto"
  level = "info"
  suppress-logo = false
```

### 4.3 Redisé…ç½®

**å®‰è£…Redis:**
```bash
# Ubuntu/Debian
sudo apt install -y redis-server

# CentOS/RHEL
sudo yum install -y redis
```

**é…ç½®æ–‡ä»¶ (`/etc/redis/redis.conf`):**
```conf
# ç½‘ç»œé…ç½®
bind 127.0.0.1
port 6379
protected-mode yes

# è®¤è¯
requirepass your-redis-password

# å†…å­˜é…ç½®
maxmemory 1gb
maxmemory-policy allkeys-lru

# æŒä¹…åŒ–
save 900 1
save 300 10
save 60 10000

# æ—¥å¿—
loglevel notice
logfile /var/log/redis/redis-server.log

# å®‰å…¨
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command DEBUG ""
```

---

## 5. å®¹å™¨åŒ–éƒ¨ç½²

### 5.1 å‰ç«¯Dockerfile

**åˆ›å»º `Dockerfile.frontend`:**
```dockerfile
# æ„å»ºé˜¶æ®µ
FROM node:18-alpine as builder

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production && npm cache clean --force

COPY . .
RUN npm run build

# ç”Ÿäº§é˜¶æ®µ
FROM nginx:alpine

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=builder /app/dist /usr/share/nginx/html

# å¤åˆ¶Nginxé…ç½®
COPY nginx.conf /etc/nginx/conf.d/default.conf

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost/ || exit 1

EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

**Nginxé…ç½® (`nginx.conf`):**
```nginx
server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /api/ {
        proxy_pass http://cogvision-api:8080/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, no-transform";
    }

    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
}
```

### 5.2 åç«¯Dockerfile

**åˆ›å»º `Dockerfile.backend`:**
```dockerfile
FROM node:18-alpine

# å®‰è£…å¿…è¦çš„ç³»ç»Ÿä¾èµ–
RUN apk add --no-cache \
    python3 \
    make \
    g++ \
    curl

WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY package*.json ./
RUN npm ci --only=production && npm cache clean --force

# å¤åˆ¶æºä»£ç 
COPY . .

# æ„å»ºåº”ç”¨
RUN npm run build

# åˆ›å»ºérootç”¨æˆ·
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nodejs -u 1001

# åˆ‡æ¢åˆ°érootç”¨æˆ·
USER nodejs

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:8080/health || exit 1

EXPOSE 8080
CMD ["node", "dist/server.js"]
```

### 5.3 Docker Composeé…ç½®

**åˆ›å»º `docker-compose.yml`:**
```yaml
version: '3.8'

services:
  # å‰ç«¯æœåŠ¡
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: cogvision-frontend
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./ssl:/etc/ssl/certs:ro
    depends_on:
      - backend
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`cogvision.yourdomain.com`)"

  # åç«¯æœåŠ¡
  backend:
    build:
      context: ./api
      dockerfile: Dockerfile.backend
    container_name: cogvision-backend
    ports:
      - "8080:8080"
    environment:
      - NODE_ENV=production
      - POSTGRES_URL=postgresql://cogvision_user:${POSTGRES_PASSWORD}@postgres:5432/cogvision
      - REDIS_URL=redis://redis:6379
      - INFLUXDB_URL=http://influxdb:8086
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      - postgres
      - redis
      - influxdb
    restart: unless-stopped
    volumes:
      - ./logs:/app/logs

  # PostgreSQLæ•°æ®åº“
  postgres:
    image: postgres:14-alpine
    container_name: cogvision-postgres
    environment:
      - POSTGRES_DB=cogvision
      - POSTGRES_USER=cogvision_user
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "5432:5432"
    restart: unless-stopped

  # InfluxDBæ—¶åºæ•°æ®åº“
  influxdb:
    image: influxdb:2.3-alpine
    container_name: cogvision-influxdb
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUXDB_PASSWORD}
      - DOCKER_INFLUXDB_INIT_ORG=cogvision
      - DOCKER_INFLUXDB_INIT_BUCKET=metrics
    volumes:
      - influxdb_data:/var/lib/influxdb2
    ports:
      - "8086:8086"
    restart: unless-stopped

  # Redisç¼“å­˜
  redis:
    image: redis:7-alpine
    container_name: cogvision-redis
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    restart: unless-stopped

volumes:
  postgres_data:
  influxdb_data:
  redis_data:

networks:
  default:
    name: cogvision-network
```

**ç¯å¢ƒå˜é‡æ–‡ä»¶ (`.env`):**
```bash
# æ•°æ®åº“å¯†ç 
POSTGRES_PASSWORD=your-secure-postgres-password
REDIS_PASSWORD=your-secure-redis-password
INFLUXDB_PASSWORD=your-secure-influxdb-password

# JWTå¯†é’¥
JWT_SECRET=your-jwt-secret-key

# åŸŸåé…ç½®
DOMAIN=cogvision.yourdomain.com

# ç›‘æ§é…ç½®
ENABLE_MONITORING=true
```

**å¯åŠ¨æœåŠ¡:**
```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f backend
```

---

## 6. Kuberneteséƒ¨ç½²

### 6.1 å‘½åç©ºé—´é…ç½®

**åˆ›å»º `k8s/namespace.yaml`:**
```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: cogvision
  labels:
    name: cogvision
```

### 6.2 ConfigMapé…ç½®

**åˆ›å»º `k8s/configmap.yaml`:**
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: cogvision-config
  namespace: cogvision
data:
  postgres_host: "cogvision-postgres"
  postgres_port: "5432"
  postgres_database: "cogvision"
  redis_host: "cogvision-redis"
  redis_port: "6379"
  influxdb_url: "http://cogvision-influxdb:8086"
  jwt_expiration: "24h"
  log_level: "info"
```

### 6.3 Secreté…ç½®

**åˆ›å»º `k8s/secret.yaml`:**
```yaml
apiVersion: v1
kind: Secret
metadata:
  name: cogvision-secrets
  namespace: cogvision
type: Opaque
data:
  postgres_password: <base64-encoded-password>
  redis_password: <base64-encoded-password>
  jwt_secret: <base64-encoded-secret>
  influxdb_token: <base64-encoded-token>
```

### 6.4 å‰ç«¯éƒ¨ç½²

**åˆ›å»º `k8s/frontend-deployment.yaml`:**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cogvision-frontend
  namespace: cogvision
spec:
  replicas: 3
  selector:
    matchLabels:
      app: cogvision-frontend
  template:
    metadata:
      labels:
        app: cogvision-frontend
    spec:
      containers:
      - name: frontend
        image: cogvision/frontend:latest
        ports:
        - containerPort: 80
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        livenessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: cogvision-frontend
  namespace: cogvision
spec:
  selector:
    app: cogvision-frontend
  ports:
  - port: 80
    targetPort: 80
  type: ClusterIP
```

### 6.5 åç«¯éƒ¨ç½²

**åˆ›å»º `k8s/backend-deployment.yaml`:**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cogvision-backend
  namespace: cogvision
spec:
  replicas: 2
  selector:
    matchLabels:
      app: cogvision-backend
  template:
    metadata:
      labels:
        app: cogvision-backend
    spec:
      containers:
      - name: backend
        image: cogvision/backend:latest
        ports:
        - containerPort: 8080
        env:
        - name: NODE_ENV
          value: "production"
        - name: POSTGRES_HOST
          valueFrom:
            configMapKeyRef:
              name: cogvision-config
              key: postgres_host
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: cogvision-secrets
              key: postgres_password
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: cogvision-secrets
              key: jwt_secret
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: cogvision-backend
  namespace: cogvision
spec:
  selector:
    app: cogvision-backend
  ports:
  - port: 8080
    targetPort: 8080
  type: ClusterIP
```

### 6.6 æ•°æ®åº“éƒ¨ç½²

**PostgreSQL StatefulSet (`k8s/postgres.yaml`):**
```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: cogvision-postgres
  namespace: cogvision
spec:
  serviceName: cogvision-postgres
  replicas: 1
  selector:
    matchLabels:
      app: cogvision-postgres
  template:
    metadata:
      labels:
        app: cogvision-postgres
    spec:
      containers:
      - name: postgres
        image: postgres:14-alpine
        ports:
        - containerPort: 5432
        env:
        - name: POSTGRES_DB
          value: cogvision
        - name: POSTGRES_USER
          value: cogvision_user
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: cogvision-secrets
              key: postgres_password
        volumeMounts:
        - name: postgres-storage
          mountPath: /var/lib/postgresql/data
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
  volumeClaimTemplates:
  - metadata:
      name: postgres-storage
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 20Gi

---
apiVersion: v1
kind: Service
metadata:
  name: cogvision-postgres
  namespace: cogvision
spec:
  selector:
    app: cogvision-postgres
  ports:
  - port: 5432
    targetPort: 5432
  type: ClusterIP
```

### 6.7 Ingressé…ç½®

**åˆ›å»º `k8s/ingress.yaml`:**
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: cogvision-ingress
  namespace: cogvision
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  tls:
  - hosts:
    - cogvision.yourdomain.com
    secretName: cogvision-tls
  rules:
  - host: cogvision.yourdomain.com
    http:
      paths:
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: cogvision-backend
            port:
              number: 8080
      - path: /
        pathType: Prefix
        backend:
          service:
            name: cogvision-frontend
            port:
              number: 80
```

**éƒ¨ç½²åˆ°Kubernetes:**
```bash
# åº”ç”¨æ‰€æœ‰é…ç½®
kubectl apply -f k8s/

# æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€
kubectl get pods -n cogvision
kubectl get services -n cogvision
kubectl get ingress -n cogvision

# æŸ¥çœ‹æ—¥å¿—
kubectl logs -f deployment/cogvision-backend -n cogvision
```

---

## 7. CI/CDæµæ°´çº¿

### 7.1 GitHub Actionsé…ç½®

**åˆ›å»º `.github/workflows/ci-cd.yml`:**
```yaml
name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run linter
      run: npm run lint
    
    - name: Run tests
      run: npm run test:coverage
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3

  build:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Login to Container Registry
      uses: docker/login-action@v2
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v4
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        file: Dockerfile.frontend
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.24.0'
    
    - name: Configure kubectl
      run: |
        echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
    
    - name: Deploy to Kubernetes
      run: |
        kubectl set image deployment/cogvision-frontend \
          frontend=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main-${{ github.sha }} \
          -n cogvision
        kubectl rollout status deployment/cogvision-frontend -n cogvision
        
    - name: Notify deployment
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#deployments'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      if: always()
```

### 7.2 GitLab CIé…ç½®

**åˆ›å»º `.gitlab-ci.yml`:**
```yaml
stages:
  - test
  - build
  - deploy

variables:
  DOCKER_TLS_CERTDIR: "/certs"
  DOCKER_DRIVER: overlay2

test:
  stage: test
  image: node:18-alpine
  cache:
    paths:
      - node_modules/
  script:
    - npm ci
    - npm run lint
    - npm run test:coverage
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml

build:
  stage: build
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -f Dockerfile.frontend -t $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA .
    - docker push $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA
    - docker tag $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE/frontend:latest
    - docker push $CI_REGISTRY_IMAGE/frontend:latest
  only:
    - main

deploy:
  stage: deploy
  image: alpine/helm:3.9.0
  before_script:
    - apk add --no-cache curl
    - curl -LO "https://dl.k8s.io/release/v1.24.0/bin/linux/amd64/kubectl"
    - install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
  script:
    - echo "$KUBE_CONFIG" | base64 -d > ~/.kube/config
    - kubectl set image deployment/cogvision-frontend frontend=$CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA -n cogvision
    - kubectl rollout status deployment/cogvision-frontend -n cogvision
  environment:
    name: production
    url: https://cogvision.yourdomain.com
  only:
    - main
```

---

## 8. ç›‘æ§å‘Šè­¦

### 8.1 Prometheusé…ç½®

**åˆ›å»º `prometheus/prometheus.yml`:**
```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "cogvision_rules.yml"

scrape_configs:
  - job_name: 'cogvision-frontend'
    static_configs:
      - targets: ['localhost:3000']
    metrics_path: '/metrics'
    scrape_interval: 30s

  - job_name: 'cogvision-backend'
    static_configs:
      - targets: ['localhost:8080']
    metrics_path: '/metrics'
    scrape_interval: 15s

  - job_name: 'postgres'
    static_configs:
      - targets: ['localhost:9187']

  - job_name: 'redis'
    static_configs:
      - targets: ['localhost:9121']

  - job_name: 'nginx'
    static_configs:
      - targets: ['localhost:9113']

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - localhost:9093
```

**å‘Šè­¦è§„åˆ™ (`prometheus/cogvision_rules.yml`):**
```yaml
groups:
  - name: cogvision.rules
    rules:
      # åº”ç”¨å¥åº·æ£€æŸ¥
      - alert: ApplicationDown
        expr: up{job=~"cogvision-.*"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "CogVisionåº”ç”¨ {{ $labels.instance }} å®•æœº"
          description: "åº”ç”¨ {{ $labels.job }} åœ¨ {{ $labels.instance }} ä¸Šå·²ç»å®•æœºè¶…è¿‡1åˆ†é’Ÿ"

      # é«˜é”™è¯¯ç‡å‘Šè­¦
      - alert: HighErrorRate
        expr: |
          (
            rate(http_requests_total{job="cogvision-backend",code=~"5.."}[5m]) /
            rate(http_requests_total{job="cogvision-backend"}[5m])
          ) * 100 > 5
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "CogVisionåç«¯é”™è¯¯ç‡è¿‡é«˜"
          description: "é”™è¯¯ç‡å·²è¾¾åˆ° {{ $value }}%ï¼Œè¶…è¿‡5%é˜ˆå€¼"

      # å“åº”æ—¶é—´å‘Šè­¦
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job="cogvision-backend"}[5m])) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "CogVisionåç«¯å“åº”æ—¶é—´è¿‡é•¿"
          description: "95%åˆ†ä½å“åº”æ—¶é—´ä¸º {{ $value }}ç§’ï¼Œè¶…è¿‡2ç§’é˜ˆå€¼"

      # å†…å­˜ä½¿ç”¨å‘Šè­¦
      - alert: HighMemoryUsage
        expr: |
          (
            process_resident_memory_bytes{job=~"cogvision-.*"} /
            (1024*1024*1024)
          ) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "CogVisionåº”ç”¨å†…å­˜ä½¿ç”¨è¿‡é«˜"
          description: "{{ $labels.job }} å†…å­˜ä½¿ç”¨å·²è¾¾åˆ° {{ $value }}GB"

      # æ•°æ®åº“è¿æ¥å‘Šè­¦
      - alert: DatabaseConnectionHigh
        expr: pg_stat_activity_count{job="postgres"} > 150
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "æ•°æ®åº“è¿æ¥æ•°è¿‡é«˜"
          description: "PostgreSQLè¿æ¥æ•°ä¸º {{ $value }}ï¼Œæ¥è¿‘é™åˆ¶"
```

### 8.2 Grafanaä»ªè¡¨ç›˜

**å¯¼å…¥ä»ªè¡¨ç›˜é…ç½® (`grafana/cogvision-dashboard.json`):**
```json
{
  "dashboard": {
    "id": null,
    "title": "CogVision ç›‘æ§ä»ªè¡¨ç›˜",
    "tags": ["cogvision", "monitoring"],
    "timezone": "browser",
    "panels": [
      {
        "id": 1,
        "title": "åº”ç”¨çŠ¶æ€",
        "type": "stat",
        "targets": [
          {
            "expr": "up{job=~\"cogvision-.*\"}",
            "legendFormat": "{{job}}"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "mappings": [
              {
                "options": {
                  "0": {
                    "text": "ä¸‹çº¿",
                    "color": "red"
                  },
                  "1": {
                    "text": "åœ¨çº¿",
                    "color": "green"
                  }
                },
                "type": "value"
              }
            ]
          }
        },
        "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0}
      },
      {
        "id": 2,
        "title": "è¯·æ±‚é‡ (QPS)",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(http_requests_total{job=\"cogvision-backend\"}[5m])",
            "legendFormat": "{{method}} {{handler}}"
          }
        ],
        "yAxes": [
          {
            "label": "è¯·æ±‚/ç§’",
            "min": 0
          }
        ],
        "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0}
      }
    ],
    "time": {
      "from": "now-1h",
      "to": "now"
    },
    "refresh": "30s"
  }
}
```

### 8.3 å‘Šè­¦é€šçŸ¥é…ç½®

**AlertManageré…ç½® (`alertmanager/alertmanager.yml`):**
```yaml
global:
  smtp_smarthost: 'smtp.company.com:587'
  smtp_from: 'alerts@cogvision.com'

route:
  group_by: ['alertname']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'web.hook'
  routes:
    - match:
        severity: critical
      receiver: 'critical-alerts'
    - match:
        severity: warning
      receiver: 'warning-alerts'

receivers:
  - name: 'web.hook'
    webhook_configs:
      - url: 'http://127.0.0.1:5001/'

  - name: 'critical-alerts'
    email_configs:
      - to: 'ops-team@company.com'
        subject: 'ğŸš¨ CogVisionä¸¥é‡å‘Šè­¦: {{ .GroupLabels.alertname }}'
        body: |
          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          è¯¦æƒ…: {{ .Annotations.description }}
          æ—¶é—´: {{ .StartsAt }}
          {{ end }}
    slack_configs:
      - api_url: 'YOUR_SLACK_WEBHOOK_URL'
        channel: '#alerts'
        title: 'CogVisionä¸¥é‡å‘Šè­¦'
        text: |
          {{ range .Alerts }}
          ğŸš¨ {{ .Annotations.summary }}
          {{ .Annotations.description }}
          {{ end }}

  - name: 'warning-alerts'
    email_configs:
      - to: 'dev-team@company.com'
        subject: 'âš ï¸ CogVisionå‘Šè­¦: {{ .GroupLabels.alertname }}'
        body: |
          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          è¯¦æƒ…: {{ .Annotations.description }}
          æ—¶é—´: {{ .StartsAt }}
          {{ end }}
```

---

## 9. æ—¥å¸¸è¿ç»´

### 9.1 å¥åº·æ£€æŸ¥è„šæœ¬

**åˆ›å»ºå¥åº·æ£€æŸ¥è„šæœ¬ (`scripts/health-check.sh`):**
```bash
#!/bin/bash

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# é…ç½®
FRONTEND_URL="https://cogvision.yourdomain.com"
BACKEND_URL="https://api.cogvision.com"
DB_HOST="localhost"

echo "ğŸ” CogVision ç³»ç»Ÿå¥åº·æ£€æŸ¥"
echo "=========================="

# æ£€æŸ¥å‰ç«¯æœåŠ¡
echo -n "æ£€æŸ¥å‰ç«¯æœåŠ¡... "
if curl -s -o /dev/null -w "%{http_code}" "$FRONTEND_URL" | grep -q "200"; then
    echo -e "${GREEN}âœ“ æ­£å¸¸${NC}"
else
    echo -e "${RED}âœ— å¼‚å¸¸${NC}"
fi

# æ£€æŸ¥åç«¯API
echo -n "æ£€æŸ¥åç«¯API... "
if curl -s -o /dev/null -w "%{http_code}" "$BACKEND_URL/health" | grep -q "200"; then
    echo -e "${GREEN}âœ“ æ­£å¸¸${NC}"
else
    echo -e "${RED}âœ— å¼‚å¸¸${NC}"
fi

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
echo -n "æ£€æŸ¥PostgreSQL... "
if pg_isready -h $DB_HOST -p 5432 -q; then
    echo -e "${GREEN}âœ“ æ­£å¸¸${NC}"
else
    echo -e "${RED}âœ— å¼‚å¸¸${NC}"
fi

# æ£€æŸ¥Redis
echo -n "æ£€æŸ¥Redis... "
if redis-cli -h $DB_HOST ping | grep -q "PONG"; then
    echo -e "${GREEN}âœ“ æ­£å¸¸${NC}"
else
    echo -e "${RED}âœ— å¼‚å¸¸${NC}"
fi

# æ£€æŸ¥ç£ç›˜ç©ºé—´
echo -n "æ£€æŸ¥ç£ç›˜ç©ºé—´... "
DISK_USAGE=$(df -h / | awk 'NR==2 {print $5}' | sed 's/%//')
if [ $DISK_USAGE -lt 80 ]; then
    echo -e "${GREEN}âœ“ æ­£å¸¸ (${DISK_USAGE}%)${NC}"
elif [ $DISK_USAGE -lt 90 ]; then
    echo -e "${YELLOW}âš  è­¦å‘Š (${DISK_USAGE}%)${NC}"
else
    echo -e "${RED}âœ— å±é™© (${DISK_USAGE}%)${NC}"
fi

# æ£€æŸ¥å†…å­˜ä½¿ç”¨
echo -n "æ£€æŸ¥å†…å­˜ä½¿ç”¨... "
MEM_USAGE=$(free | grep Mem | awk '{printf("%.1f", $3/$2 * 100.0)}')
if (( $(echo "$MEM_USAGE < 80" | bc -l) )); then
    echo -e "${GREEN}âœ“ æ­£å¸¸ (${MEM_USAGE}%)${NC}"
elif (( $(echo "$MEM_USAGE < 90" | bc -l) )); then
    echo -e "${YELLOW}âš  è­¦å‘Š (${MEM_USAGE}%)${NC}"
else
    echo -e "${RED}âœ— å±é™© (${MEM_USAGE}%)${NC}"
fi

echo "=========================="
echo "å¥åº·æ£€æŸ¥å®Œæˆ $(date)"
```

### 9.2 å¤‡ä»½è„šæœ¬

**åˆ›å»ºæ•°æ®åº“å¤‡ä»½è„šæœ¬ (`scripts/backup.sh`):**
```bash
#!/bin/bash

# é…ç½®
BACKUP_DIR="/var/backups/cogvision"
DB_NAME="cogvision"
DB_USER="cogvision_user"
RETENTION_DAYS=30

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# ç”Ÿæˆæ—¶é—´æˆ³
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")

echo "ğŸ—„ï¸ å¼€å§‹å¤‡ä»½ CogVision æ•°æ®åº“..."

# PostgreSQLå¤‡ä»½
echo "å¤‡ä»½PostgreSQLæ•°æ®åº“..."
pg_dump -h localhost -U $DB_USER -d $DB_NAME -f "$BACKUP_DIR/postgres_${TIMESTAMP}.sql"
if [ $? -eq 0 ]; then
    echo "âœ… PostgreSQLå¤‡ä»½æˆåŠŸ"
    gzip "$BACKUP_DIR/postgres_${TIMESTAMP}.sql"
else
    echo "âŒ PostgreSQLå¤‡ä»½å¤±è´¥"
    exit 1
fi

# InfluxDBå¤‡ä»½
echo "å¤‡ä»½InfluxDBæ•°æ®..."
influx backup -t $(cat ~/.influxdb_token) "$BACKUP_DIR/influxdb_${TIMESTAMP}"
if [ $? -eq 0 ]; then
    echo "âœ… InfluxDBå¤‡ä»½æˆåŠŸ"
    tar -czf "$BACKUP_DIR/influxdb_${TIMESTAMP}.tar.gz" -C "$BACKUP_DIR" "influxdb_${TIMESTAMP}"
    rm -rf "$BACKUP_DIR/influxdb_${TIMESTAMP}"
else
    echo "âŒ InfluxDBå¤‡ä»½å¤±è´¥"
fi

# æ¸…ç†æ—§å¤‡ä»½
echo "æ¸…ç†è¶…è¿‡ ${RETENTION_DAYS} å¤©çš„æ—§å¤‡ä»½..."
find $BACKUP_DIR -name "*.sql.gz" -mtime +$RETENTION_DAYS -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +$RETENTION_DAYS -delete

echo "ğŸ‰ å¤‡ä»½å®Œæˆï¼"
echo "å¤‡ä»½æ–‡ä»¶ä½ç½®: $BACKUP_DIR"
ls -lh $BACKUP_DIR/*${TIMESTAMP}*
```

### 9.3 æ—¥å¿—æ¸…ç†è„šæœ¬

**åˆ›å»ºæ—¥å¿—æ¸…ç†è„šæœ¬ (`scripts/log-cleanup.sh`):**
```bash
#!/bin/bash

# é…ç½®
LOG_DIRS=(
    "/var/log/nginx"
    "/var/log/postgresql"
    "/opt/cogvision/logs"
    "/var/lib/docker/containers"
)
RETENTION_DAYS=30

echo "ğŸ§¹ å¼€å§‹æ¸…ç†ç³»ç»Ÿæ—¥å¿—..."

for LOG_DIR in "${LOG_DIRS[@]}"; do
    if [ -d "$LOG_DIR" ]; then
        echo "æ¸…ç†ç›®å½•: $LOG_DIR"
        
        # åˆ é™¤è¶…è¿‡ä¿ç•™æœŸçš„æ—¥å¿—æ–‡ä»¶
        find "$LOG_DIR" -name "*.log" -mtime +$RETENTION_DAYS -delete 2>/dev/null
        find "$LOG_DIR" -name "*.log.*" -mtime +$RETENTION_DAYS -delete 2>/dev/null
        find "$LOG_DIR" -name "*.gz" -mtime +$RETENTION_DAYS -delete 2>/dev/null
        
        echo "âœ… $LOG_DIR æ¸…ç†å®Œæˆ"
    else
        echo "âš ï¸ ç›®å½•ä¸å­˜åœ¨: $LOG_DIR"
    fi
done

# æ¸…ç†ç³»ç»Ÿæ—¥å¿—
echo "æ¸…ç†systemdæ—¥å¿—..."
journalctl --vacuum-time=${RETENTION_DAYS}d

# æ¸…ç†Dockeræ—¥å¿—
echo "æ¸…ç†Dockeræ—¥å¿—..."
if command -v docker &> /dev/null; then
    docker system prune -f --volumes
fi

echo "ğŸ‰ æ—¥å¿—æ¸…ç†å®Œæˆï¼"

# æ˜¾ç¤ºç£ç›˜ä½¿ç”¨æƒ…å†µ
echo "å½“å‰ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
df -h
```

### 9.4 æ€§èƒ½ç›‘æ§è„šæœ¬

**åˆ›å»ºæ€§èƒ½ç›‘æ§è„šæœ¬ (`scripts/performance-monitor.sh`):**
```bash
#!/bin/bash

# é…ç½®
REPORT_FILE="/tmp/cogvision-performance-$(date +%Y%m%d).txt"
API_URL="https://api.cogvision.com"

echo "ğŸ“Š CogVision æ€§èƒ½ç›‘æ§æŠ¥å‘Š" > $REPORT_FILE
echo "ç”Ÿæˆæ—¶é—´: $(date)" >> $REPORT_FILE
echo "======================================" >> $REPORT_FILE

# ç³»ç»Ÿè´Ÿè½½
echo "" >> $REPORT_FILE
echo "ç³»ç»Ÿè´Ÿè½½:" >> $REPORT_FILE
uptime >> $REPORT_FILE

# CPUä½¿ç”¨ç‡
echo "" >> $REPORT_FILE
echo "CPUä½¿ç”¨ç‡:" >> $REPORT_FILE
top -bn1 | grep "Cpu(s)" >> $REPORT_FILE

# å†…å­˜ä½¿ç”¨
echo "" >> $REPORT_FILE
echo "å†…å­˜ä½¿ç”¨:" >> $REPORT_FILE
free -h >> $REPORT_FILE

# ç£ç›˜IO
echo "" >> $REPORT_FILE
echo "ç£ç›˜IO:" >> $REPORT_FILE
iostat -x 1 1 >> $REPORT_FILE

# ç½‘ç»œè¿æ¥
echo "" >> $REPORT_FILE
echo "ç½‘ç»œè¿æ¥ç»Ÿè®¡:" >> $REPORT_FILE
netstat -s | grep -E "(connections|requests)" >> $REPORT_FILE

# APIå“åº”æ—¶é—´æµ‹è¯•
echo "" >> $REPORT_FILE
echo "APIå“åº”æ—¶é—´æµ‹è¯•:" >> $REPORT_FILE
for endpoint in "/health" "/api/dashboard/metrics" "/api/sessions/search"; do
    response_time=$(curl -o /dev/null -s -w "%{time_total}" "$API_URL$endpoint")
    echo "$endpoint: ${response_time}s" >> $REPORT_FILE
done

# æ•°æ®åº“æ€§èƒ½
echo "" >> $REPORT_FILE
echo "æ•°æ®åº“è¿æ¥æ•°:" >> $REPORT_FILE
psql -h localhost -U cogvision_user -d cogvision -c "SELECT count(*) as active_connections FROM pg_stat_activity;" >> $REPORT_FILE

echo "ğŸ“Š æ€§èƒ½ç›‘æ§å®Œæˆï¼ŒæŠ¥å‘Šå·²ä¿å­˜åˆ°: $REPORT_FILE"
```

---

## 10. æ•…éšœæ’æŸ¥

### 10.1 å¸¸è§é—®é¢˜è¯Šæ–­

**å‰ç«¯æ— æ³•è®¿é—®:**
```bash
# æ£€æŸ¥NginxçŠ¶æ€
sudo systemctl status nginx
sudo nginx -t

# æŸ¥çœ‹Nginxé”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/error.log

# æ£€æŸ¥ç«¯å£å ç”¨
sudo netstat -tulpn | grep :80
sudo netstat -tulpn | grep :443

# æ£€æŸ¥SSLè¯ä¹¦
openssl x509 -in /etc/ssl/certs/cogvision.crt -text -noout
```

**åç«¯APIé”™è¯¯:**
```bash
# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
sudo journalctl -u cogvision-api -f

# æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
ps aux | grep cogvision

# æ£€æŸ¥ç«¯å£ç›‘å¬
sudo netstat -tulpn | grep :8080

# æ£€æŸ¥åº”ç”¨å¥åº·
curl -I http://localhost:8080/health
```

**æ•°æ®åº“è¿æ¥é—®é¢˜:**
```bash
# æ£€æŸ¥PostgreSQLçŠ¶æ€
sudo systemctl status postgresql
sudo -u postgres psql -c "SELECT version();"

# æŸ¥çœ‹è¿æ¥æ•°
sudo -u postgres psql -c "SELECT count(*) FROM pg_stat_activity;"

# æ£€æŸ¥æ…¢æŸ¥è¯¢
sudo -u postgres psql -c "SELECT query, query_start, now() - query_start AS duration FROM pg_stat_activity WHERE now() - query_start > interval '30 seconds';"

# æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—
sudo tail -f /var/log/postgresql/postgresql-*.log
```

### 10.2 æ•…éšœæ¢å¤æµç¨‹

**æœåŠ¡å®•æœºæ¢å¤:**
```bash
#!/bin/bash
# æœåŠ¡æ¢å¤è„šæœ¬

echo "ğŸš¨ å¼€å§‹æ•…éšœæ¢å¤æµç¨‹..."

# 1. åœæ­¢æ‰€æœ‰æœåŠ¡
echo "åœæ­¢æœåŠ¡..."
sudo systemctl stop nginx
sudo systemctl stop cogvision-api

# 2. æ£€æŸ¥è¿›ç¨‹
echo "æ£€æŸ¥æ®‹ç•™è¿›ç¨‹..."
pkill -f cogvision || true

# 3. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
sudo rm -rf /tmp/cogvision-*
sudo rm -rf /var/run/cogvision-*

# 4. æ£€æŸ¥ç£ç›˜ç©ºé—´
echo "æ£€æŸ¥ç£ç›˜ç©ºé—´..."
df -h

# 5. å¯åŠ¨æ•°æ®åº“æœåŠ¡
echo "å¯åŠ¨æ•°æ®åº“æœåŠ¡..."
sudo systemctl start postgresql
sudo systemctl start redis-server

# ç­‰å¾…æ•°æ®åº“å¯åŠ¨
sleep 10

# 6. å¯åŠ¨åº”ç”¨æœåŠ¡
echo "å¯åŠ¨åº”ç”¨æœåŠ¡..."
sudo systemctl start cogvision-api
sleep 5
sudo systemctl start nginx

# 7. éªŒè¯æœåŠ¡çŠ¶æ€
echo "éªŒè¯æœåŠ¡çŠ¶æ€..."
curl -f http://localhost:8080/health
curl -f http://localhost/

echo "âœ… æ•…éšœæ¢å¤å®Œæˆï¼"
```

**æ•°æ®æ¢å¤æµç¨‹:**
```bash
#!/bin/bash
# æ•°æ®æ¢å¤è„šæœ¬

BACKUP_FILE="$1"
DB_NAME="cogvision"
DB_USER="cogvision_user"

if [ -z "$BACKUP_FILE" ]; then
    echo "ç”¨æ³•: $0 <backup_file.sql.gz>"
    exit 1
fi

echo "ğŸ—„ï¸ å¼€å§‹æ•°æ®æ¢å¤æµç¨‹..."

# 1. åœæ­¢åº”ç”¨æœåŠ¡
echo "åœæ­¢åº”ç”¨æœåŠ¡..."
sudo systemctl stop cogvision-api

# 2. åˆ›å»ºæ•°æ®åº“å¤‡ä»½
echo "åˆ›å»ºå½“å‰æ•°æ®åº“å¤‡ä»½..."
pg_dump -h localhost -U $DB_USER -d $DB_NAME -f "/tmp/pre_restore_backup_$(date +%Y%m%d_%H%M%S).sql"

# 3. åˆ é™¤ç°æœ‰æ•°æ®åº“
echo "åˆ é™¤ç°æœ‰æ•°æ®åº“..."
sudo -u postgres psql -c "DROP DATABASE IF EXISTS $DB_NAME;"

# 4. åˆ›å»ºæ–°æ•°æ®åº“
echo "åˆ›å»ºæ–°æ•°æ®åº“..."
sudo -u postgres psql -c "CREATE DATABASE $DB_NAME OWNER $DB_USER;"

# 5. æ¢å¤æ•°æ®
echo "æ¢å¤æ•°æ®..."
gunzip -c "$BACKUP_FILE" | psql -h localhost -U $DB_USER -d $DB_NAME

if [ $? -eq 0 ]; then
    echo "âœ… æ•°æ®æ¢å¤æˆåŠŸ"
else
    echo "âŒ æ•°æ®æ¢å¤å¤±è´¥"
    exit 1
fi

# 6. å¯åŠ¨åº”ç”¨æœåŠ¡
echo "å¯åŠ¨åº”ç”¨æœåŠ¡..."
sudo systemctl start cogvision-api

# 7. éªŒè¯æ¢å¤
echo "éªŒè¯æ•°æ®æ¢å¤..."
curl -f http://localhost:8080/health

echo "ğŸ‰ æ•°æ®æ¢å¤å®Œæˆï¼"
```

### 10.3 æ€§èƒ½ä¼˜åŒ–æŒ‡å—

**æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–:**
```sql
-- åˆ†ææ…¢æŸ¥è¯¢
SELECT query, mean_time, calls, total_time
FROM pg_stat_statements
ORDER BY mean_time DESC
LIMIT 10;

-- æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT schemaname, tablename, attname, n_distinct, correlation
FROM pg_stats
WHERE schemaname = 'public'
ORDER BY n_distinct DESC;

-- åˆ†æè¡¨å¤§å°
SELECT schemaname, tablename, 
       pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size,
       pg_total_relation_size(schemaname||'.'||tablename) as size_bytes
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY size_bytes DESC;
```

**åº”ç”¨æ€§èƒ½ä¼˜åŒ–:**
```bash
# Node.jsåº”ç”¨å†…å­˜åˆ†æ
node --inspect=0.0.0.0:9229 server.js

# ç”ŸæˆHeap Dump
kill -USR2 $(pgrep -f "node.*server.js")

# CPUæ€§èƒ½åˆ†æ
perf record -g node server.js
perf report
```

---

## æ€»ç»“

æœ¬éƒ¨ç½²è¿ç»´æŒ‡å—æ¶µç›–äº†CogVisionç³»ç»Ÿçš„å®Œæ•´éƒ¨ç½²å’Œè¿ç»´æµç¨‹ï¼ŒåŒ…æ‹¬ï¼š

1. **ç¯å¢ƒå‡†å¤‡** - ç³»ç»Ÿè¦æ±‚ã€ä¾èµ–å®‰è£…
2. **æœåŠ¡éƒ¨ç½²** - å‰ç«¯ã€åç«¯ã€æ•°æ®åº“é…ç½®
3. **å®¹å™¨åŒ–** - Dockerå’ŒKuberneteséƒ¨ç½²
4. **CI/CD** - è‡ªåŠ¨åŒ–æ„å»ºå’Œéƒ¨ç½²
5. **ç›‘æ§å‘Šè­¦** - Prometheusã€Grafanaé…ç½®
6. **æ—¥å¸¸è¿ç»´** - å¥åº·æ£€æŸ¥ã€å¤‡ä»½ã€æ¸…ç†è„šæœ¬
7. **æ•…éšœæ’æŸ¥** - é—®é¢˜è¯Šæ–­å’Œæ¢å¤æµç¨‹

é€šè¿‡éµå¾ªæœ¬æŒ‡å—ï¼Œå¯ä»¥ç¡®ä¿CogVisionç³»ç»Ÿçš„ç¨³å®šè¿è¡Œå’Œé«˜å¯ç”¨æ€§ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬:** v1.0  
**æœ€åæ›´æ–°:** 2024-08-21  
**ç»´æŠ¤äººå‘˜:** DevOpså›¢é˜Ÿ  
**è”ç³»æ–¹å¼:** ops@cogvision.com